<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IBMMQSink.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Siddhi Extension - IBMMQ Transport</a> &gt; <a href="index.source.html" class="el_package">org.wso2.extension.siddhi.io.ibmmq.sink</a> &gt; <span class="el_source">IBMMQSink.java</span></div><h1>IBMMQSink.java</h1><pre class="source lang-java linenums">/*
 *  Copyright (c) 2018 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 *
 *  WSO2 Inc. licenses this file to you under the Apache License,
 *  Version 2.0 (the &quot;License&quot;); you may not use this file except
 *  in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing,
 *  software distributed under the License is distributed on an
 *  &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 *  KIND, either express or implied.  See the License for the
 *  specific language governing permissions and limitations
 *  under the License.
 *
 */

package org.wso2.extension.siddhi.io.ibmmq.sink;

import com.ibm.mq.jms.MQQueueConnectionFactory;
import com.ibm.msg.client.wmq.WMQConstants;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.wso2.extension.siddhi.io.ibmmq.sink.exception.IBMMQSinkAdaptorRuntimeException;
import org.wso2.extension.siddhi.io.ibmmq.util.IBMMQConstants;
import org.wso2.siddhi.annotation.Example;
import org.wso2.siddhi.annotation.Extension;
import org.wso2.siddhi.annotation.Parameter;
import org.wso2.siddhi.annotation.util.DataType;
import org.wso2.siddhi.core.config.SiddhiAppContext;
import org.wso2.siddhi.core.exception.ConnectionUnavailableException;
import org.wso2.siddhi.core.stream.output.sink.Sink;
import org.wso2.siddhi.core.util.config.ConfigReader;
import org.wso2.siddhi.core.util.transport.DynamicOptions;
import org.wso2.siddhi.core.util.transport.OptionHolder;
import org.wso2.siddhi.query.api.definition.StreamDefinition;

import java.nio.ByteBuffer;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import javax.jms.BytesMessage;
import javax.jms.JMSException;
import javax.jms.MapMessage;
import javax.jms.Message;
import javax.jms.MessageConsumer;
import javax.jms.Queue;
import javax.jms.QueueConnection;
import javax.jms.QueueSender;
import javax.jms.QueueSession;
import javax.jms.Session;

/**
 * IBM MQ Sink implementation
 **/

@Extension(
        name = &quot;ibmmq&quot;,
        namespace = &quot;sink&quot;,
        description = &quot;IBM MQ sink allows you to publish messages to an IBM MQ broker.&quot;,
        parameters = {
                @Parameter(name = IBMMQConstants.DESTINATION_NAME,
                        description = &quot;The name of the queue to which the IBM MQ sink should send events.&quot;,
                        type = DataType.STRING),
                @Parameter(name = IBMMQConstants.HOST,
                        description = &quot;The host address of the MQ server.&quot;,
                        type = DataType.STRING),
                @Parameter(name = IBMMQConstants.PORT,
                        description = &quot;The port of the MQ server.&quot;,
                        type = DataType.STRING),
                @Parameter(name = IBMMQConstants.CHANNEL,
                        description = &quot;The channel used to connect to the MQ server.&quot;,
                        type = DataType.STRING),
                @Parameter(name = IBMMQConstants.QUEUE_MANAGER_NAME,
                        description = &quot;The name of the queue manager.&quot;,
                        type = DataType.STRING),
                @Parameter(name = IBMMQConstants.USER_NAME,
                        description = &quot;The username to connect to the server. If this is not provided, the &quot; +
                                &quot;connection is attempted without both the username and the password.&quot;,
                        type = DataType.STRING,
                        optional = true,
                        defaultValue = &quot;null&quot;),
                @Parameter(name = IBMMQConstants.PASSWORD,
                        description = &quot;The password to connect to the server. If this is not provided, the &quot; +
                                &quot;connection is attempted without both the username and the password.&quot;,
                        type = DataType.STRING,
                        optional = true,
                        defaultValue = &quot;null&quot;),
                @Parameter(name = IBMMQConstants.PROPERTIES,
                        description = &quot;IBM MQ properties which are supported by the client can be provided as key &quot; +
                                &quot;value pairs which is separated by \&quot;,\&quot;. as an example &quot; +
                                &quot;batch.properties = 'XMSC_WMQ_CLIENT_RECONNECT_OPTIONS:1600,&quot; +
                                &quot;WMQ_CLIENT_RECONNECT:5005'.&quot;,
                        type = DataType.STRING,
                        optional = true,
                        defaultValue = &quot;null&quot;)
        },
        examples = {
                @Example(description = &quot;This example shows how to connect to an IBM MQ queue and send messages.&quot;,
                        syntax = &quot;@sink(type='ibmmq',&quot;
                                + &quot;destination.name='Queue1',&quot;
                                + &quot;host='192.168.56.3',&quot;
                                + &quot;port='1414',&quot;
                                + &quot;channel='Channel1',&quot;
                                + &quot;queue.manager = 'ESBQManager',&quot;
                                + &quot;password='1920',&quot;
                                + &quot;username='mqm',&quot;
                                + &quot;batch.properties = 'XMSC_WMQ_CLIENT_RECONNECT_OPTIONS:1600,&quot; +
                                &quot;WMQ_CLIENT_RECONNECT:5005',&quot;
                                + &quot;@map(type='text'))&quot;
                                + &quot;define stream SweetProductionStream(name string, amount double);&quot;
                ),
        }
)

<span class="nc" id="L118">public class IBMMQSink extends Sink {</span>
<span class="nc" id="L119">    private static final Logger LOG = LoggerFactory.getLogger(IBMMQSink.class);</span>
    private OptionHolder optionHolder;
    private QueueConnection connection;
    private MQQueueConnectionFactory connectionFactory;
    private StreamDefinition outputStreamDefinition;
    private QueueSession session;
    private Queue queue;
    private QueueSender messageSender;
    private MessageConsumer consumer;
    private String userName;
    private String password;
    private String queueName;
    private String properties;
<span class="nc" id="L132">    private boolean isSecured = false;</span>
    private SiddhiAppContext siddhiAppContext;

    @Override
    public Class[] getSupportedInputEventClasses() {
<span class="nc" id="L137">        return new Class[]{String.class, Map.class, ByteBuffer.class};</span>
    }

    @Override
    public String[] getSupportedDynamicOptions() {
<span class="nc" id="L142">        return new String[0];</span>
    }

    @Override
    protected void init(StreamDefinition outputStreamDefinition, OptionHolder optionHolder, ConfigReader
            sinkConfigReader, SiddhiAppContext siddhiAppContext) {
<span class="nc" id="L148">        this.siddhiAppContext = siddhiAppContext;</span>
<span class="nc" id="L149">        this.optionHolder = optionHolder;</span>
<span class="nc" id="L150">        this.connectionFactory = new MQQueueConnectionFactory();</span>
<span class="nc" id="L151">        this.outputStreamDefinition = outputStreamDefinition;</span>
<span class="nc" id="L152">        this.queueName = optionHolder.validateAndGetStaticValue(IBMMQConstants.DESTINATION_NAME);</span>
<span class="nc" id="L153">        this.userName = optionHolder.validateAndGetStaticValue(IBMMQConstants.USER_NAME,</span>
<span class="nc" id="L154">                sinkConfigReader.readConfig(IBMMQConstants.USER_NAME, null));</span>
<span class="nc" id="L155">        this.password = optionHolder.validateAndGetStaticValue(IBMMQConstants.PASSWORD,</span>
<span class="nc" id="L156">                sinkConfigReader.readConfig(IBMMQConstants.PASSWORD, null));</span>
<span class="nc" id="L157">        this.properties = optionHolder.validateAndGetStaticValue(IBMMQConstants.PROPERTIES, sinkConfigReader.readConfig</span>
<span class="nc" id="L158">                (IBMMQConstants.PROPERTIES, null));</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (properties != null) {</span>
            try {
<span class="nc" id="L161">                connectionFactory.setBatchProperties(generatePropertyMap(properties));</span>
<span class="nc" id="L162">            } catch (JMSException e) {</span>
<span class="nc" id="L163">                throw new IBMMQSinkAdaptorRuntimeException(&quot;Error occurred while initializing IBM MQ with &quot; +</span>
<span class="nc" id="L164">                        &quot;provided sink batch.properties for '&quot; + siddhiAppContext.getName() + &quot;' sink&quot;, e);</span>
<span class="nc" id="L165">            }</span>
        }
<span class="nc bnc" id="L167" title="All 4 branches missed.">        if (Objects.nonNull(userName) &amp;&amp; Objects.nonNull(password)) {</span>
<span class="nc" id="L168">            isSecured = true;</span>
        }
        try {
<span class="nc" id="L171">            connectionFactory.setQueueManager(optionHolder.validateAndGetOption(IBMMQConstants.QUEUE_MANAGER_NAME).</span>
<span class="nc" id="L172">                    getValue());</span>
<span class="nc" id="L173">            connectionFactory.setTransportType(WMQConstants.WMQ_CM_CLIENT);</span>
<span class="nc" id="L174">            connectionFactory.setPort(Integer.parseInt(optionHolder.validateAndGetOption(IBMMQConstants.PORT)</span>
<span class="nc" id="L175">                    .getValue()));</span>
<span class="nc" id="L176">            connectionFactory.setHostName(optionHolder.validateAndGetOption(IBMMQConstants.HOST).getValue());</span>
<span class="nc" id="L177">            connectionFactory.setChannel(optionHolder.validateAndGetOption(IBMMQConstants.CHANNEL).getValue());</span>
<span class="nc" id="L178">        } catch (JMSException e) {</span>
<span class="nc" id="L179">            throw new IBMMQSinkAdaptorRuntimeException(&quot;Error while initializing IBM MQ sink: &quot; + optionHolder.</span>
<span class="nc" id="L180">                    validateAndGetOption(IBMMQConstants.DESTINATION_NAME).getValue() + &quot;, &quot; + e.getMessage(), e);</span>
<span class="nc" id="L181">        }</span>
<span class="nc" id="L182">    }</span>

    @Override
    public void publish(Object payload, DynamicOptions transportOptions) throws ConnectionUnavailableException {
        try {
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (payload instanceof String) {</span>
<span class="nc" id="L188">                Message message = session.createTextMessage(payload.toString());</span>
<span class="nc" id="L189">                messageSender.send(message);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">            } else if (payload instanceof Map) {</span>
<span class="nc" id="L191">                MapMessage mapMessage = session.createMapMessage();</span>
<span class="nc" id="L192">                ((Map) payload).forEach((key, value) -&gt; {</span>
                    try {
<span class="nc" id="L194">                        mapMessage.setString((String) key, (String) value);</span>
<span class="nc" id="L195">                    } catch (JMSException e) {</span>
<span class="nc" id="L196">                        throw new IBMMQSinkAdaptorRuntimeException(&quot;Exception occurred while publishing payload: &quot; +</span>
                                &quot;key - '&quot; + key + &quot;', value - '&quot; + value + &quot;' from stream: '&quot;
<span class="nc" id="L198">                                + outputStreamDefinition.getId() + &quot;'. &quot;, e);</span>
<span class="nc" id="L199">                    }</span>
<span class="nc" id="L200">                });</span>
<span class="nc" id="L201">                messageSender.send(mapMessage);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">            } else if (payload instanceof ByteBuffer) {</span>
<span class="nc" id="L203">                byte[] data = ((ByteBuffer) payload).array();</span>
<span class="nc" id="L204">                BytesMessage bytesMessage = session.createBytesMessage();</span>
<span class="nc" id="L205">                bytesMessage.writeBytes(data);</span>
<span class="nc" id="L206">                messageSender.send(bytesMessage);</span>
            }
<span class="nc" id="L208">        } catch (JMSException e) {</span>
<span class="nc" id="L209">            throw new IBMMQSinkAdaptorRuntimeException(&quot;Exception occurred while publishing payload: &quot; +</span>
<span class="nc" id="L210">                    payload.toString() + &quot; , &quot;, e);</span>
<span class="nc" id="L211">        }</span>
<span class="nc" id="L212">    }</span>

    @Override
    public void connect() throws ConnectionUnavailableException {
        try {
<span class="nc bnc" id="L217" title="All 2 branches missed.">            if (isSecured) {</span>
<span class="nc" id="L218">                connection = (QueueConnection) connectionFactory.createConnection(userName, password);</span>
            } else {
<span class="nc" id="L220">                connection = (QueueConnection) connectionFactory.createConnection();</span>
            }
<span class="nc" id="L222">            session = (QueueSession) connection.createSession(false, Session.AUTO_ACKNOWLEDGE);</span>
<span class="nc" id="L223">            queue = session.createQueue(optionHolder.validateAndGetOption(IBMMQConstants.DESTINATION_NAME)</span>
<span class="nc" id="L224">                    .getValue());</span>
<span class="nc" id="L225">            consumer = session.createConsumer(queue);</span>
<span class="nc" id="L226">            messageSender = session.createSender(queue);</span>
<span class="nc" id="L227">        } catch (JMSException e) {</span>
<span class="nc" id="L228">            throw new ConnectionUnavailableException(&quot;Exception occurred while connecting to the IBM MQ for queue: '&quot;</span>
<span class="nc" id="L229">                    + queueName + &quot;' in siddhi app: '&quot; + siddhiAppContext.getName() + &quot;'. &quot;, e);</span>
<span class="nc" id="L230">        }</span>
<span class="nc" id="L231">    }</span>

    @Override
    public void disconnect() {
        try {

        } finally {
<span class="nc bnc" id="L238" title="All 2 branches missed.">            if (Objects.nonNull(messageSender)) {</span>
                try {
<span class="nc" id="L240">                    messageSender.close();</span>
<span class="nc" id="L241">                } catch (JMSException e) {</span>
<span class="nc" id="L242">                    LOG.error(&quot;Error occurred while closing the message sender for the queue: &quot; + queueName + &quot; in &quot; +</span>
<span class="nc" id="L243">                            &quot;siddhi app &quot; + siddhiAppContext.getName(), e);</span>
<span class="nc" id="L244">                }</span>
            }
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (Objects.nonNull(consumer)) {</span>
                try {
<span class="nc" id="L248">                    consumer.close();</span>
<span class="nc" id="L249">                } catch (JMSException e) {</span>
<span class="nc" id="L250">                    LOG.error(&quot;Error occurred while closing the consumer for the queue: &quot; + queueName + &quot; in &quot; +</span>
                            &quot;                            \&quot;siddhi app \&quot; + siddhiAppContext.getName()&quot;, e);
<span class="nc" id="L252">                }</span>
            }
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (Objects.nonNull(connection)) {</span>
                try {
<span class="nc" id="L256">                    connection.close();</span>
<span class="nc" id="L257">                } catch (JMSException e) {</span>
<span class="nc" id="L258">                    LOG.error(&quot;Error occurred while closing the IBM MQ connection for the queue: &quot; + queueName + &quot; in&quot; +</span>
<span class="nc" id="L259">                            &quot; siddhi app&quot; + siddhiAppContext.getName() + &quot; &quot;, e);</span>
<span class="nc" id="L260">                }</span>
            }
        }
<span class="nc" id="L263">    }</span>

    @Override
    public void destroy() {
        // disconnect() gets called before destroy() which does the cleanup destroy() needs
<span class="nc" id="L268">    }</span>

    @Override
    public Map&lt;String, Object&gt; currentState() {
<span class="nc" id="L272">        return null;</span>
    }

    @Override
    public void restoreState(Map&lt;String, Object&gt; state) {
        //not available
<span class="nc" id="L278">    }</span>

    private Map&lt;String, Object&gt; generatePropertyMap(String properties) {
<span class="nc" id="L281">        Map&lt;String, Object&gt; propertyMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L282">        String[] propertiesArray = properties.split(&quot;,&quot;);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        for (String property : propertiesArray) {</span>
<span class="nc" id="L284">            String[] propertyArray = property.trim().split(&quot;:&quot;);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (propertyArray.length == 2) {</span>
<span class="nc" id="L286">                propertyMap.put(propertyArray[0], propertyArray[1]);</span>
            } else {
<span class="nc" id="L288">                throw new IBMMQSinkAdaptorRuntimeException(&quot;Error occurred while creating the property map. &quot; +</span>
<span class="nc" id="L289">                        &quot;Properties should be provided as key value pairs for '&quot; + siddhiAppContext.getName() +</span>
                        &quot;' sink&quot;);
            }
        }
<span class="nc" id="L293">        return propertyMap;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>