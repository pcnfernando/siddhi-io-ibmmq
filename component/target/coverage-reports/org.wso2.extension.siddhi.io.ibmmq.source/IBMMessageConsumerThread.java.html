<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IBMMessageConsumerThread.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Siddhi Extension - IBMMQ Transport</a> &gt; <a href="index.source.html" class="el_package">org.wso2.extension.siddhi.io.ibmmq.source</a> &gt; <span class="el_source">IBMMessageConsumerThread.java</span></div><h1>IBMMessageConsumerThread.java</h1><pre class="source lang-java linenums">/*
 *  Copyright (c) 2018 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 *
 *  WSO2 Inc. licenses this file to you under the Apache License,
 *  Version 2.0 (the &quot;License&quot;); you may not use this file except
 *  in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing,
 *  software distributed under the License is distributed on an
 *  &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 *  KIND, either express or implied.  See the License for the
 *  specific language governing permissions and limitations
 *  under the License.
 *
 */
package org.wso2.extension.siddhi.io.ibmmq.source;

import com.ibm.mq.jms.MQConnection;
import com.ibm.mq.jms.MQQueueConnectionFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.wso2.siddhi.core.stream.input.source.SourceEventListener;

import java.nio.ByteBuffer;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.ReentrantLock;
import javax.jms.ExceptionListener;
import javax.jms.JMSException;
import javax.jms.MapMessage;
import javax.jms.Message;
import javax.jms.MessageConsumer;
import javax.jms.Queue;
import javax.jms.Session;
import javax.jms.TextMessage;

/**
 * IBM MQ message consumer class which retrieve messages from the queue.
 **/
public class IBMMessageConsumerThread implements Runnable {

<span class="nc" id="L48">    private static final Logger logger = LoggerFactory.getLogger(IBMMessageConsumerThread.class);</span>
    private SourceEventListener sourceEventListener;
    private MQConnection connection;
    private MessageConsumer messageConsumer;
    private volatile boolean paused;
    private volatile boolean inactive;
    private ReentrantLock lock;
    private Condition condition;

    private String queueName;
    private IBMMessageConsumerBean ibmMessageConsumerBean;
    private MQQueueConnectionFactory mqQueueConnectionFactory;
    private IBMMQConnectionRetryHandler ibmmqConnectionRetryHandler;

    public IBMMessageConsumerThread(SourceEventListener sourceEventListener,
                                    IBMMessageConsumerBean ibmMessageConsumerBean,
<span class="nc" id="L64">                                    MQQueueConnectionFactory mqQueueConnectionFactory) throws JMSException {</span>

<span class="nc" id="L66">        this.ibmMessageConsumerBean = ibmMessageConsumerBean;</span>
<span class="nc" id="L67">        this.mqQueueConnectionFactory = mqQueueConnectionFactory;</span>
<span class="nc" id="L68">        this.sourceEventListener = sourceEventListener;</span>
<span class="nc" id="L69">        this.queueName = ibmMessageConsumerBean.getQueueName();</span>
<span class="nc" id="L70">        this.ibmmqConnectionRetryHandler = new IBMMQConnectionRetryHandler(this,</span>
<span class="nc" id="L71">                ibmMessageConsumerBean.getRetryInterval(), ibmMessageConsumerBean.getMaxRetryCount());</span>
<span class="nc" id="L72">        lock = new ReentrantLock();</span>
<span class="nc" id="L73">        condition = lock.newCondition();</span>
<span class="nc" id="L74">        connect();</span>
<span class="nc" id="L75">    }</span>

    @Override
    public void run() {

<span class="nc bnc" id="L80" title="All 2 branches missed.">        while (!inactive) {</span>
            try {
<span class="nc bnc" id="L82" title="All 2 branches missed.">                if (paused) {</span>
<span class="nc" id="L83">                    lock.lock();</span>
                    try {
<span class="nc" id="L85">                        condition.await();</span>
<span class="nc" id="L86">                    } catch (InterruptedException ie) {</span>
<span class="nc" id="L87">                        Thread.currentThread().interrupt();</span>
                    } finally {
<span class="nc" id="L89">                        lock.unlock();</span>
<span class="nc" id="L90">                    }</span>
                }
<span class="nc" id="L92">                Message message = messageConsumer.receive();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                if (message instanceof MapMessage) {</span>
<span class="nc" id="L94">                    Map&lt;String, Object&gt; event = new HashMap&lt;&gt;();</span>
<span class="nc" id="L95">                    MapMessage mapEvent = (MapMessage) message;</span>
<span class="nc" id="L96">                    Enumeration&lt;String&gt; mapNames = mapEvent.getMapNames();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                    while (mapNames.hasMoreElements()) {</span>
<span class="nc" id="L98">                        String key = mapNames.nextElement();</span>
<span class="nc" id="L99">                        event.put(key, mapEvent.getObject(key));</span>
<span class="nc" id="L100">                    }</span>
<span class="nc" id="L101">                    sourceEventListener.onEvent(event, null);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                } else if (message instanceof TextMessage) {</span>
<span class="nc" id="L103">                    String event = ((TextMessage) message).getText();</span>
<span class="nc" id="L104">                    sourceEventListener.onEvent(event, null);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                } else if (message instanceof ByteBuffer) {</span>
<span class="nc" id="L106">                    sourceEventListener.onEvent(message, null);</span>
                }
<span class="nc" id="L108">            } catch (Throwable t) {</span>
<span class="nc" id="L109">                logger.error(&quot;Exception occurred during consuming messages at queue '&quot;</span>
<span class="nc" id="L110">                        + queueName + &quot;' &quot; + t.getMessage(), t);</span>
<span class="nc" id="L111">            }</span>
        }
<span class="nc" id="L113">    }</span>

    void pause() {
<span class="nc" id="L116">        paused = true;</span>
<span class="nc" id="L117">    }</span>

    void resume() {
<span class="nc" id="L120">        paused = false;</span>
        try {
<span class="nc" id="L122">            lock.lock();</span>
<span class="nc" id="L123">            condition.signalAll();</span>
        } finally {
<span class="nc" id="L125">            lock.unlock();</span>
<span class="nc" id="L126">        }</span>
<span class="nc" id="L127">    }</span>

    void shutdownConsumer() {
<span class="nc" id="L130">        inactive = true;</span>
        try {
<span class="nc bnc" id="L132" title="All 2 branches missed.">            if (Objects.nonNull(messageConsumer)) {</span>
<span class="nc" id="L133">                messageConsumer.close();</span>
            }
<span class="nc" id="L135">        } catch (JMSException e) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L137">                logger.debug(&quot;Error occurred while closing the consumer for the queue: &quot; + queueName + &quot;. &quot;, e);</span>
            }
<span class="nc" id="L139">        }</span>
        try {
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (Objects.nonNull(connection)) {</span>
<span class="nc" id="L142">                connection.close();</span>
            }
<span class="nc" id="L144">        } catch (JMSException e) {</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L146">                logger.debug(&quot;Error occurred while closing the IBM MQ connection for the queue: &quot;</span>
                        + queueName + &quot;. &quot;, e);
            }
<span class="nc" id="L149">        }</span>
<span class="nc" id="L150">    }</span>

    public void connect() throws JMSException {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (ibmMessageConsumerBean.isSecured()) {</span>
<span class="nc" id="L154">            connection = (MQConnection) mqQueueConnectionFactory.createConnection(</span>
<span class="nc" id="L155">                    ibmMessageConsumerBean.getUserName(), ibmMessageConsumerBean.getPassword());</span>
        } else {
<span class="nc" id="L157">            connection = (MQConnection) mqQueueConnectionFactory.createConnection();</span>
        }
<span class="nc" id="L159">        ExceptionListener exceptionListener = new ExceptionListener() {</span>
            @Override
            public void onException(JMSException e) {
<span class="nc" id="L162">                logger.error(&quot;Connection failure at queue:&quot; + queueName);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L164">                    logger.debug(&quot;Exception was caught at IBMMQ connection exception listener.&quot;, e);</span>
                }
<span class="nc bnc" id="L166" title="All 2 branches missed.">                if (!ibmmqConnectionRetryHandler.retry()) {</span>
<span class="nc" id="L167">                    logger.error(&quot;Connection to the MQ provider failed after retrying for &quot;</span>
<span class="nc" id="L168">                            + ibmmqConnectionRetryHandler.getRetryCount() + &quot; times.&quot;, e);</span>
                }
<span class="nc" id="L170">            }</span>
        };
<span class="nc" id="L172">        connection.setExceptionListener(exceptionListener);</span>
<span class="nc" id="L173">        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);</span>
<span class="nc" id="L174">        Queue queue = session.createQueue(ibmMessageConsumerBean.getDestinationName());</span>
<span class="nc" id="L175">        this.messageConsumer = session.createConsumer(queue);</span>
<span class="nc" id="L176">        this.connection.start();</span>
<span class="nc" id="L177">    }</span>

    public String getQueueName() {
<span class="nc" id="L180">        return queueName;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>